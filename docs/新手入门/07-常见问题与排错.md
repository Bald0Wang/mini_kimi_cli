# 07. 磨砺：与 Bug 共舞 (Troubleshooting)

> "任何一个程序，只要它有用，就必定包含 Bug。" —— 墨菲定律的推论

在编程的世界里，遇到错误（Bug）不是意外，而是常态。不要害怕红色的报错信息，它们是程序在向你求救，也是你理解系统内部运作的最佳机会。每一次排错（Debugging），都是一次侦探游戏。这一章，我们将传授给你几招“侦探技巧”，助你从容应对开发中的拦路虎。

### 知识加油站 ⛽️

#### 1. 回溯 (Traceback)
当 Python 程序崩溃时，它会打印出一串长长的文本，这就是回溯。它记录了程序崩溃时调用栈的状态，就像是案发现场的“录像回放”。学会从下往上看 Traceback，找到最后一行属于你自己的代码，通常就能定位问题所在。
*   **参考阅读**: [Understanding Python Tracebacks](https://realpython.com/python-traceback/)

#### 2. 小黄鸭调试法 (Rubber Duck Debugging)
这是一种非常有效的调试方法：当你卡住时，找一只小黄鸭（或者任何静物），详细地向它解释你的代码在做什么，以及你想让它做什么。通常在解释的过程中，你自己就会发现逻辑漏洞。
*   **参考来源**: [Rubber Duck Debugging](https://rubberduckdebugging.com/)

---

### 学习目标

- 新手遇到问题时能快速定位：是依赖问题、配置问题、导入路径问题，还是网络问题
- 形成“先复现 → 再缩小范围 → 再修复”的排错习惯

---

## 1) 导入与运行问题

### `ModuleNotFoundError: No module named 'mini_kimi'`

- **原因**：`mini_kimi/src` 没有加入 Python 的模块搜索路径
- **解决（推荐）**：

```powershell
$env:PYTHONPATH="mini_kimi/src"
python mini_kimi/src/mini_kimi/ui/shell/main.py
```

**快速自检**

- 在同一个终端里执行：`python -c "import sys; print(sys.path[0:3])"`
- 确认输出里包含 `.../mini_kimi/src`

---

## 2) 模型鉴权问题

### 401 / `Invalid Authentication`

- **原因**：`MOONSHOT_API_KEY` 没设置或无效
- **解决**：
  - 重新设置环境变量
  - 关闭当前终端再打开（确保环境变量生效）
  - 再运行

---

## 3) Web 搜索/抓取问题

### `SearchWeb` 提示缺少依赖

- **原因**：未安装 `ddgs`
- **解决**：

```bash
pip install ddgs
```

### 搜索返回 `No results found`

- **原因**：网络/地区限制/搜索后端波动
- **建议**：
  - 更换关键词（更短、更具体）
  - 换英文关键词
  - 先测试 `FetchURL` 是否能抓取一个已知网址

### 抓取网页返回空或乱码

- **原因**：网页是强 JS 渲染 / 反爬 / 编码复杂
- **建议**：
  - 优先抓取“文档类站点”的页面（通常更容易提取文本）
  - 更换 URL（同主题的另一个来源）
  - 降低预期：抓取工具在教学版里是“尽力而为”的纯文本提取

---

## 4) Windows 命令差异（BashTool）

### `head` / `grep` 等命令不存在

- **原因**：Windows 默认不提供 GNU 工具链
- **建议**：
  - 用 PowerShell 命令替代（如 `Get-Content -TotalCount 20 file`）
  - 或安装 Git Bash/WSL（进阶）

---

## 5) 工具参数解析失败（JSON 相关）

### `json.loads(...)` 报错

- **原因**：模型返回的 `function.arguments` 不是合法 JSON（例如用了单引号、漏了逗号）
- **建议**：
  - 在 system prompt 增加一句：工具参数必须输出为严格 JSON
  - 或在代码侧做容错（进阶）：捕获异常并把错误回填给模型，让模型自我修正
