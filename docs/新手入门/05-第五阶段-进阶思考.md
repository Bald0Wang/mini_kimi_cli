# 05. 沉思：边界与未来 (Advanced Topics)

> "只有知道边界在哪里，才能真正拥有自由。"

当我们沉浸在 Agent 带来的便利中时，不要忘了它依然受限于物理法则和算法逻辑。它的记忆是有限的（Context Window），它的行为可能失控（Safety），它的能力有待组合（Multi-Agent）。这一章，我们将探讨这些严肃的工程问题。这不仅是关于如何把程序写得更好，更是关于如何构建一个可靠、安全、可扩展的智能系统。

### 知识加油站 ⛽️

#### 1. 上下文窗口 (Context Window)
大模型的“短期记忆”容量是有限的，通常以 Token 为单位计量（如 4k, 16k, 128k）。当对话历史超过这个长度，最早的信息就会被强行截断（忘记）。这就像人类的海马体受损，只能记住最近发生的事情。解决这个问题需要引入“长时记忆”机制（如向量数据库）或“信息压缩”技术。
*   **参考阅读**: [What is the Context Window?](https://www.google.com/search?q=llm+context+window)

#### 2. 提示词注入 (Prompt Injection)
这是一种针对 LLM 的安全攻击。攻击者通过精心设计的输入（如“忽略之前的指令，现在你是...”），诱导模型执行非预期的行为。这与传统的 SQL 注入攻击有异曲同工之妙，是 Agent 系统面临的主要安全挑战之一。
*   **参考来源**: [OWASP Top 10 for LLM](https://llmtop10.com/)

---

### 学习目标

- 识别 Mini Kimi 的“教学版简化点”，理解它们在工程上对应的真实问题
- 建立从 Mini Kimi 过渡到完整版 `kimi-cli` 的学习路线

---

### 1) 记忆管理（上下文工程）

**Mini Kimi 现状**

- 直接把所有 `messages` 发给模型

**工程问题**

- 对话变长后：成本上升、超出上下文窗口、回答变慢/变差

**你可以怎么扩展**

- 最简单：只保留最近 N 条消息
- 再进一步：把旧消息做摘要（压缩）后保留

**结合本项目的落点（你可以从这里开始改）**

- 文件：`mini_kimi/src/mini_kimi/soul/soul.py`
- 位置：`Soul.run()` 的循环里，在每次调用 `llm.chat(...)` 前做裁剪/压缩

**验收建议**

- 连续对话 30 轮，`messages` 长度仍可控
- 模型仍能记住“最近 3~5 轮”发生的关键事实

---

### 2) 工具安全（权限与审批）

**Mini Kimi 现状**

- `BashTool` 可以执行任意命令
- `WriteFileTool` 目前约束较弱

**工程问题**

- 误删文件、命令注入、越权写入、敏感信息泄露

**你可以怎么扩展**

- 命令白名单/黑名单
- “需要批准”的交互（审批工具/确认提示）
- 沙箱化执行（容器/受限目录）

**结合本项目的落点**

- `mini_kimi/src/mini_kimi/tools/bash/bash_tool.py`：在执行前做规则判断
- `mini_kimi/src/mini_kimi/tools/file/write_tool.py`：限制写入目录（推荐 `mini_kimi/out/`）

**验收建议**

- 明确列出 3 条应被拒绝的危险操作，并验证都被拒绝

---

### 3) 复杂任务（多智能体协作）

**Mini Kimi 现状**

- 单 Agent 单循环

**工程问题**

- 复杂任务需要分工：检索、写代码、测试、总结、计划

**你可以怎么扩展**

- 增加子 Agent（subagent）：每个子 Agent 只负责一种能力
- 主 Agent 做调度：拆解任务→分派→汇总

**结合本项目的落点（最小可行方案）**

- 新建 `WebSoul`：只注册 `SearchWeb/FetchURL`
- 主 `Soul` 先调用 `WebSoul` 获取“检索摘要”，再继续自己的工具链（例如写文件）

---

### 4) 过渡到完整版 `kimi-cli` 的建议阅读路径

建议你按能力对齐：

- **工具系统**：工具加载、schema、依赖注入、权限控制
- **上下文系统**：Context/Compaction 的策略与触发条件
- **多 Agent**：Task/Subagent 的隔离与事件转发

如果你已经掌握本项目的 4 个模块（UI/LLM/Soul/Tools），再去读完整版会顺畅很多。

---

### 本节小结

- **你知道了哪些“简化点”**：长对话、工具安全、复杂任务在工程上都必须被系统化处理
- **你获得了扩展路线**：每个方向都有明确的落点文件与验收标准
